image: alpine/edge
secrets:
  - 354867a0-91a5-4404-ab08-6a875e3ea941
packages:
  - go
  - hut
  - golangci-lint
  - make
  - gcc
  - musl-dev
tasks:
  - prepare: |
      cd forge
      git checkout go
  - build: |
      cd forge
      make
  - lint: |
      cd forge
      golangci-lint run .
  - upload: |
      cd forge
      x="$(git describe --exact || true)"
      if [ -z "$x" ]; then
      	printf 'Not a tag, not uploading artifacts\n' >&2
      else
      	mv forge forge-"$x"-linux-amd64
      	hut git artifact -r forge upload forge-"$x"-linux-amd64
      fi
